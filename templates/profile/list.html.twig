{# templates/profile/list.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Liste des Profils{% endblock %}

{% block body %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/ProfiList.css') }}">
{% endblock %}

<section class="list-page">

    <header class="page-header">
        <h1>Liste des profils</h1>
        <p>Trouve des profils selon tes critères.</p>

        {# ✅ Quota profils/jour pour non premium #}
        {% if app.user and profileViewQuota and profileViewQuota.isLimited %}
            <div class="alert alert-info mt-3 mb-0">
                Profils vus aujourd’hui : <strong>{{ profileViewQuota.usedToday }}/{{ profileViewQuota.limit }}</strong>
                — Restants : <strong>{{ profileViewQuota.remaining }}</strong>
                <span class="ms-2">Abonnement = profils illimités.</span>
            </div>
        {% endif %}
    </header>

    {# ----------- TRI ------------ #}
    <article class="filter-card" id="sortContainer">
        <header class="filter-header">
            <h2>Filtres</h2>
            <p>Affinez la recherche</p>
        </header>

        <form method="GET" action="{{ path('app_profiles_list') }}" class="filter-form">

            <div class="filter-row">
                <div class="filter-group">
                    <div class="filter-label">Sexe</div>
                    <label class="check">
                        <input type="checkbox" name="sex[]" value="Homme" {% if 'Homme' in sex %}checked{% endif %}>
                        <span>Homme</span>
                    </label>
                    <label class="check">
                        <input type="checkbox" name="sex[]" value="Femme" {% if 'Femme' in sex %}checked{% endif %}>
                        <span>Femme</span>
                    </label>
                    <label class="check">
                        <input type="checkbox" name="sex[]" value="Autre" {% if 'Autre' in sex %}checked{% endif %}>
                        <span>Autre</span>
                    </label>
                </div>

                <div class="filter-group">
                    <div class="filter-label">Situation</div>
                    <label class="check">
                        <input type="checkbox" name="situation[]" value="Celibataire" {% if 'Celibataire' in situation %}checked{% endif %}>
                        <span>Célibataire</span>
                    </label>
                    <label class="check">
                        <input type="checkbox" name="situation[]" value="En couple" {% if 'En couple' in situation %}checked{% endif %}>
                        <span>En couple</span>
                    </label>
                </div>

                <div class="filter-group">
                    <div class="filter-label">Qui recherche</div>
                    <label class="check">
                        <input type="checkbox" name="research[]" value="Homme" {% if 'Homme' in research %}checked{% endif %}>
                        <span>Homme</span>
                    </label>
                    <label class="check">
                        <input type="checkbox" name="research[]" value="Femme" {% if 'Femme' in research %}checked{% endif %}>
                        <span>Femme</span>
                    </label>
                    <label class="check">
                        <input type="checkbox" name="research[]" value="Couple" {% if 'Couple' in research %}checked{% endif %}>
                        <span>Couple</span>
                    </label>
                </div>

                <div class="filter-group">
                    <div class="filter-label">Ville</div>
                    <input type="text" name="city" class="input" value="{{ city }}" placeholder="Ville">
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Appliquer</button>
                <button id="toggleSortBtn" type="button" class="btn btn-ghost">Afficher / Masquer</button>
            </div>
        </form>
    </article>

    {# Quota atteint ? #}
    {% set quotaReached = (app.user and profileViewQuota and profileViewQuota.isLimited and profileViewQuota.remaining <= 0) %}

    {% if quotaReached %}
        <div class="alert alert-warning">
            Limite atteinte : <strong>{{ profileViewQuota.limit }}</strong> profils/jour.
            <a href="{{ path('app_stripe_subscribe') }}" class="alert-link">S’abonner</a> pour voir des profils en illimité.
        </div>
    {% endif %}

    {# ----------- LISTE DES PROFILS ------------ #}
    <section class="profiles-grid">
        {% for profile in profiles %}
            {% if profile.user.pseudo != app.user.pseudo %}

                {% set profileIsPremium = ('ROLE_PREMIUM' in profile.user.roles) %}

                <article class="profile-card">

                    <div class="card-inner">
                        {# Bloc gauche (avatar + boutons) #}
                        <div class="card-left">
                            <a
                                class="avatar-link {% if quotaReached %}card-disabled{% endif %}"
                                href="{% if quotaReached %}{{ path('app_stripe_subscribe') }}{% else %}{{ path('app_profile_view', { id: profile.id }) }}{% endif %}"
                                {% if quotaReached %}title="Limite atteinte : abonne-toi pour voir plus de profils"{% endif %}
                            >
                                <div class="avatar-wrap">
                                    <img src="{{ asset(profile.avatar ? 'uploads/avatars/' ~ profile.avatar : 'uploads/avatars/default-avatar.png') }}" alt="Avatar de {{ profile.user.pseudo }}">
                                    {% if profileIsPremium %}
                                        <span class="premium-dot" title="Profil Premium">⭐</span>
                                    {% endif %}
                                </div>
                            </a>

                            <div class="left-actions">
                                <a href="{{ path('app_messages', { id: profile.user.id }) }}" class="btn btn-primary btn-small">Message</a>

                                <button class="btn btn-outline btn-small"
                                        data-id="{{ profile.id }}"
                                        data-token="{{ csrf_token('like' ~ profile.id) }}"
                                        data-url="{{ path('app_profile_like', { id: profile.id }) }}">
                                    Like ❤️
                                </button>
                            </div>
                        </div>

                        {# Bloc droit (infos cliquables) #}
                        <a
                            class="card-right {% if quotaReached %}card-disabled{% endif %}"
                            href="{% if quotaReached %}{{ path('app_stripe_subscribe') }}{% else %}{{ path('app_profile_view', { id: profile.id }) }}{% endif %}"
                            {% if quotaReached %}title="Limite atteinte : abonne-toi pour voir plus de profils"{% endif %}
                        >
                            <div class="card-main">
                                {% if profileIsPremium %}
                                    <span class="premium-badge" title="Profil Premium">Premium</span>
                                {% endif %}

                                <h2 class="name">
                                    {{ profile.user.pseudo }}
                                </h2>

                                <div class="meta">
                                    <span class="pill">{{ profile.sex|default('Inc') }}</span>
                                    {% if profile.age %}
                                        <span class="sep">—</span>
                                        <span>{{ profile.age }} ans</span>
                                    {% endif %}
                                </div>

                                <div class="city"><strong>De </strong>{{ profile.city|default('Inc') }}</div>

                                <div class="search">
                                    <strong>Ici pour </strong>
                                    {% if profile.research is iterable %}
                                        {{ profile.research|join(', ')|default('Inc') }}
                                    {% else %}
                                        {{ profile.research|default('Inc') }}
                                    {% endif %}
                                </div>

                                <p class="bio">
                                    {{ profile.biography|default('Aucune biographie.') }}
                                </p>
                            </div>
                        </a>
                    </div>

                </article>
            {% endif %}
        {% endfor %}
    </section>

</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggleSortBtn');
    const sortContainer = document.getElementById('sortContainer');

    sortContainer.classList.add('collapsed');

    toggleBtn.addEventListener('click', () => {
        sortContainer.classList.toggle('collapsed');
    });

    document.querySelectorAll('.btn-outline').forEach(btn => {
        btn.addEventListener('click', () => {
            fetch(btn.dataset.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ _token: btn.dataset.token })
            })
            .then(r => r.json())
            .then(d => alert(d.message));
        });
    });
});
</script>

{% endblock %}
