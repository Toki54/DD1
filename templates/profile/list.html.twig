{% extends 'base.html.twig' %}

{% block title %}Liste des Profils
{% endblock %}

{% block body %}
	{% block stylesheet %}
		<link rel="stylesheet" href="{{ asset('css/list.css') }}">
	{% endblock %}

	<section class="container">

		<article class="sort-container" id="sortContainer">
			<header class="sort-header">
				<h3>Filtrer les profils</h3>
			</header>
			<section class="sort-content">
				<form method="GET" action="{{ path('app_profiles_list') }}" class="sort-form">
					<label>Sexe:
						<input type="checkbox" name="sex[]" value="Homme" {% if 'Homme' in sex %} checked {% endif %}>
						Homme
						<input type="checkbox" name="sex[]" value="Femme" {% if 'Femme' in sex %} checked {% endif %}>
						Femme
						<input type="checkbox" name="sex[]" value="Autre" {% if 'Autre' in sex %} checked {% endif %}>
						Autre
					</label>

					<label>Situation:
						<input type="checkbox" name="situation[]" value="Celibataire" {% if 'Celibataire' in situation %} checked {% endif %}>
						Célibataire
						<input type="checkbox" name="situation[]" value="En couple" {% if 'En couple' in situation %} checked {% endif %}>
						En couple
					</label>

					<label>Recherche:
						<input type="checkbox" name="research[]" value="Homme" {% if 'Homme' in research %} checked {% endif %}>
						Homme
						<input type="checkbox" name="research[]" value="Femme" {% if 'Femme' in research %} checked {% endif %}>
						Femme
						<input type="checkbox" name="research[]" value="Couple" {% if 'Couple' in research %} checked {% endif %}>
						Couple
					</label>

					<label>Département:
						<select name="department">
							<option value="">Tous</option>
							{% for code, name in {
								"01":"Ain", "02":"Aisne", "03":"Allier", "04":"Alpes-de-Haute-Provence", "05":"Hautes-Alpes",
								"06":"Alpes-Maritimes", "07":"Ardèche", "08":"Ardennes", "09":"Ariège", "10":"Aube",
								"11":"Aude", "12":"Aveyron", "13":"Bouches-du-Rhône", "14":"Calvados", "15":"Cantal",
								"16":"Charente", "17":"Charente-Maritime", "18":"Cher", "19":"Corrèze", "21":"Côte-d'Or",
								"22":"Côtes-d'Armor", "23":"Creuse", "24":"Dordogne", "25":"Doubs", "26":"Drôme",
								"27":"Eure", "28":"Eure-et-Loir", "29":"Finistère", "2A":"Corse-du-Sud", "2B":"Haute-Corse",
								"30":"Gard", "31":"Haute-Garonne", "32":"Gers", "33":"Gironde", "34":"Hérault",
								"35":"Ille-et-Vilaine", "36":"Indre", "37":"Indre-et-Loire", "38":"Isère", "39":"Jura",
								"40":"Landes", "41":"Loir-et-Cher", "42":"Loire", "43":"Haute-Loire", "44":"Loire-Atlantique",
								"45":"Loiret", "46":"Lot", "47":"Lot-et-Garonne", "48":"Lozère", "49":"Maine-et-Loire",
								"50":"Manche", "51":"Marne", "52":"Haute-Marne", "53":"Mayenne", "54":"Meurthe-et-Moselle",
								"55":"Meuse", "56":"Morbihan", "57":"Moselle", "58":"Nièvre", "59":"Nord",
								"60":"Oise", "61":"Orne", "62":"Pas-de-Calais", "63":"Puy-de-Dôme", "64":"Pyrénées-Atlantiques",
								"65":"Hautes-Pyrénées", "66":"Pyrénées-Orientales", "67":"Bas-Rhin", "68":"Haut-Rhin", "69":"Rhône",
								"70":"Haute-Saône", "71":"Saône-et-Loire", "72":"Sarthe", "73":"Savoie", "74":"Haute-Savoie",
								"75":"Paris", "76":"Seine-Maritime", "77":"Seine-et-Marne", "78":"Yvelines", "79":"Deux-Sèvres",
								"80":"Somme", "81":"Tarn", "82":"Tarn-et-Garonne", "83":"Var", "84":"Vaucluse",
								"85":"Vendée", "86":"Vienne", "87":"Haute-Vienne", "88":"Vosges", "89":"Yonne",
								"90":"Territoire de Belfort", "91":"Essonne", "92":"Hauts-de-Seine", "93":"Seine-Saint-Denis", "94":"Val-de-Marne",
								"95":"Val-d'Oise"
							} %}
								<option value="{{ code }}" {% if department == code %} selected {% endif %}>{{ code }}
									-
									{{ name }}</option>
							{% endfor %}
						</select>
					</label>

					<label>Ville:
						<input type="text" name="city" value="{{ city }}" placeholder="Ville" class="autocomplete-city" id="cityInput" autocomplete="off">
						<ul id="citySuggestions" class="suggestions-list"></ul>
					</label>

					<button type="submit">Appliquer le tri</button>
				</form>
			</section>
		</article>

		<button id="toggleSortBtn" class="toggle-sort-btn" aria-expanded="true" aria-controls="sortContainer">
			Afficher / Masquer les filtres
		</button>

<section class="profile-container">
	{% for profile in profiles %}
		{% if profile.user.pseudo != app.user.pseudo %}
			<article class="profile-card">
				<div class="avatar">
					<img src="{{ asset(profile.avatar ? 'uploads/avatars/' ~ profile.avatar : 'uploads/avatars/default-avatar.png') }}" alt="Avatar">
				</div>
				<div class="profile-details">
					<div class="profile-top">
						<h2>
							<a href="{{ path('app_profile_view', { id: profile.id }) }}" class="profile-link">{{ profile.user.pseudo }}</a>
							-
							{{ profile.city|default('Inc') }}
						</h2>
					</div>
					<div class="profile-info">
						<p>
							<strong>{{ profile.sex|default('Inc') }}</strong>
							de
							{% if profile.birthdate %}
								{% set now = "now"|date("Y") %}
								{% set birthYear = profile.birthdate|date("Y") %}
								{{ now - birthYear }}
								ans
							{% endif %}
						</p>
						<p class="rech">
							<strong>pour :</strong><br>
							{% if profile.research is iterable %}
								{{ profile.research|join(', ')|default('Inc') }}
								<br>
							{% else %}
								{{ profile.research|default('Inc') }}<br>
							{% endif %}
						</p>
					</div>
				</div>
				<div class="profile-biography">
					<p title="{{ profile.biography|default('Aucune') }}">{{ profile.biography|default('Aucune') }}</p>
				</div>
				<div class="profile-actions">
					<a href="{{ path('app_messages', { id: profile.user.id }) }}" class="btn-message" title="Envoyer un message">
						<img src="/public/images/messagerie.png" alt="Message">
					</a>
					<button class="btn-like clean-button" title="Liker ce profil" data-id="{{ profile.id }}" data-token="{{ csrf_token('like' ~ profile.id) }}" data-url="{{ path('app_profile_like', { id: profile.id }) }}">
						<img src="{{ asset('images/like.png') }}" alt="like" class="like-icon">
					</button>

				</div>
			</article>
		{% endif %}
	{% endfor %}
</section>

	</section>

	 <script>
						document.addEventListener('DOMContentLoaded', () => {
							const toggleBtn = document.getElementById('toggleSortBtn');
							const sortContainer = document.getElementById('sortContainer');
				
							toggleBtn.addEventListener('click', () => {
								const isVisible = sortContainer.classList.toggle('hidden');
								toggleBtn.setAttribute('aria-expanded', !isVisible);
							});
				
							document.querySelectorAll('.btn-like').forEach(button => {
								button.addEventListener('click', () => {
									const url = button.getAttribute('data-url');
									const csrfToken = button.getAttribute('data-token');
				
									fetch(url, {
										method: 'POST',
										headers: {
											'Content-Type': 'application/json',
											'X-Requested-With': 'XMLHttpRequest',
										},
										body: JSON.stringify({ _token: csrfToken })
									})
									.then(res => res.json())
									.then(data => alert(data.message))
									.catch(error => {
										alert('Erreur lors du like');
										console.error(error);
									});
								});
							});
				
							// Autocomplétion ville (simple et côté client)
							const cityInput = document.getElementById('cityInput');
							const suggestionsBox = document.getElementById('citySuggestions');
				
							const villes = [
								'Paris', 'Lyon', 'Marseille', 'Toulouse', 'Nice', 'Nantes', 'Strasbourg',
								'Lille', 'Bordeaux', 'Rennes', 'Reims', 'Le Havre', 'Saint-Étienne',
								'Toulon', 'Grenoble', 'Dijon', 'Angers', 'Nîmes', 'Villeurbanne',
								
				'Nancy',
				'Villers-lès-Nancy',
				'Laxou',
				'Maxéville',
				'Mallette',
				'Vandoeuvre-lès-Nancy',
				'Jarville-la-Malgrange',
				'Tomblaine',
				'Essey-lès-Nancy',
				'Saint-Max',
				'Heillecourt',
				'Laneuveville-devant-Nancy',
				'Pulnoy',
				'Seichamps',
				'Houdemont',
				'Fléville-devant-Nancy',
				'Art-sur-Meurthe',
				'Saulxures-lès-Nancy',
				'Dommartemont',
				'Agincourt'
								
							];
				
							cityInput.addEventListener('input', () => {
								const input = cityInput.value.toLowerCase();
								suggestionsBox.innerHTML = '';
				
								if (input.length < 2) return;
				
								const matches = villes.filter(v => v.toLowerCase().includes(input));
								matches.forEach(match => {
									const li = document.createElement('li');
									li.textContent = match;
									li.addEventListener('click', () => {
										cityInput.value = match;
										suggestionsBox.innerHTML = '';
									});
									suggestionsBox.appendChild(li);
								});
							});
						});
					</script>
{% endblock %}
