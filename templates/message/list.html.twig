{% extends 'base.html.twig' %}

{% block title %}Liste des Conversations
{% endblock %}

{% block body %}

{% block stylesheet %}
	<link rel="stylesheet" href="{{ asset('css/listMess.css') }}">
{% endblock %}

	<h1>Mes conversations</h1>

<!-- Liste des conversations -->
<section class="conversation-container">
	{% for userGroup in groupedMessages %}
		<div class="card mb-3">
			<div class="card-header">
				<h5>{{ userGroup.user.pseudo }}</h5>
				<!-- Bouton pour afficher/masquer les messages -->
				<button class="btn btn-secondary toggle-conversation" data-target="conversation-{{ userGroup.user.id }}">
					Afficher/Masquer la discussion
				</button>
			</div>
			<div class="card-body" id="conversation-{{ userGroup.user.id }}" style="display: none;">
				<!-- Affiche les messages échangés -->
<ul class="list-group">
	{% for message in userGroup.messages %}
		<li class="list-group-item {% if message.sender == app.user %}text-end{% endif %}">
			<strong>{{ message.sender.pseudo }}:</strong>
			{{ message.content }}

{% if message.isChatRequest %}
	<span class="badge bg-warning">Demande de discussion</span>
	{% if app.user == message.receiver %}
		<form action="{{ path('app_message_accept', {'id': message.id}) }}" method="POST">
			<button type="submit" class="btn btn-success btn-sm mt-2">Accepter</button>
		</form>
	{% endif %}
{% endif %}

		</li>
	{% endfor %}
</ul>


				<!-- Formulaire pour envoyer un message -->
				<form action="{{ path('app_message_create', {'id': userGroup.user.id}) }}" method="POST">
					{{ form_start(forms[userGroup.user.id]) }}
					{{ form_row(forms[userGroup.user.id].content) }}
					<button type="submit" class="btn btn-primary mt-3">Envoyer un message</button>
					{{ form_end(forms[userGroup.user.id]) }}
				</form>
			</div>
		</div>
	{% else %}
		<p>Vous n'avez pas encore de conversations.</p>
	{% endfor %}
</section>

 <script>
    document.addEventListener("DOMContentLoaded", function() {
    // ✅ Gestion de l'affichage des discussions ouvertes
    document.querySelectorAll(".toggle-conversation").forEach(button => {
        button.addEventListener("click", function() {
            let targetId = this.getAttribute("data-target");
            let targetElement = document.getElementById(targetId);

            if (targetElement.style.display === "none" || targetElement.style.display === "") {
                targetElement.style.display = "block"; // Affiche la discussion
                saveOpenConversations(targetId, true); // Sauvegarde l'état
            } else {
                targetElement.style.display = "none";  // Masque la discussion
                saveOpenConversations(targetId, false); // Sauvegarde l'état
            }
        });
    });

    // ✅ Restaurer les discussions ouvertes après un rafraîchissement
    restoreOpenConversations();

    // ✅ Gestion de l'envoi des messages en AJAX
    document.querySelectorAll(".message-form").forEach(form => {
        form.addEventListener("submit", function(event) {
            event.preventDefault(); // Empêche le rechargement de la page

            let input = this.querySelector(".message-input");
            let content = input.value.trim();
            let conversationId = this.dataset.conversationId;

            if (content === "") return;

            fetch(this.action, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let messageList = document.querySelector(`#conversation-${conversationId} .list-group`);

                    let newMessage = document.createElement("li");
                    newMessage.classList.add("list-group-item", "text-end", "fade-in");
                    newMessage.innerHTML = `<strong>${data.message.sender}:</strong> ${data.message.content} <span class="text-muted">${data.message.sentAt}</span>`;

                    messageList.appendChild(newMessage);
                    input.value = ""; // Réinitialise le champ
                    scrollToBottom(messageList);
                } else {
                    console.error("Erreur: La réponse du serveur ne contient pas de message valide.");
                }
            })
            .catch(error => console.error("Erreur lors de l'envoi:", error));
        });
    });
});

/**
 * ✅ Sauvegarde l'état des discussions ouvertes dans localStorage
 */
function saveOpenConversations(id, isOpen) {
    let openConversations = JSON.parse(localStorage.getItem("openConversations")) || {};
    openConversations[id] = isOpen;
    localStorage.setItem("openConversations", JSON.stringify(openConversations));
}

/**
 * ✅ Restaure les discussions ouvertes après un rafraîchissement
 */
function restoreOpenConversations() {
    let openConversations = JSON.parse(localStorage.getItem("openConversations")) || {};
    Object.keys(openConversations).forEach(id => {
        if (openConversations[id]) {
            let targetElement = document.getElementById(id);
            if (targetElement) targetElement.style.display = "block";
        }
    });
}

/**
 * ✅ Scroll automatique vers le bas après l'ajout d'un message
 */
function scrollToBottom(element) {
    element.scrollTop = element.scrollHeight;
}

</script>

	
	{% endblock %}




