{% extends 'base.html.twig' %}

{% block title %}Liste des Conversations
{% endblock %}

{% block body %}

{% block stylesheet %}
	<link rel="stylesheet" href="{{ asset('css/listMess.css') }}">
{% endblock %}

	<h1>Mes conversations</h1>

<!-- Liste des conversations -->
<section class="conversation-container">
	{% for userGroup in groupedMessages %}
		<div class="card mb-3">
			<div class="card-header">
				<h5>{{ userGroup.user.pseudo }}</h5>
				<!-- Bouton pour afficher/masquer les messages -->
				<button class="btn btn-secondary toggle-conversation" data-target="conversation-{{ userGroup.user.id }}">
					Afficher/Masquer la discussion
				</button>
			</div>
			<div class="card-body" id="conversation-{{ userGroup.user.id }}" style="display: none;">
				<!-- Affiche les messages échangés -->
<ul class="list-group">
	{% for message in userGroup.messages %}
		<li class="list-group-item {% if message.sender == app.user %}text-end{% endif %}">
			<strong>{{ message.sender.pseudo }}:</strong>
			{{ message.content }}

{% if message.isChatRequest %}
	<span class="badge bg-warning">Demande de discussion</span>
	{% if app.user == message.receiver %}
		<form action="{{ path('app_message_accept', {'id': message.id}) }}" method="POST">
			<button type="submit" class="btn btn-success btn-sm mt-2">Accepter</button>
		</form>
	{% endif %}
{% endif %}

		</li>
	{% endfor %}
</ul>


				<!-- Formulaire pour envoyer un message -->
				<form action="{{ path('app_message_create', {'id': userGroup.user.id}) }}" method="POST">
					{{ form_start(forms[userGroup.user.id]) }}
					{{ form_row(forms[userGroup.user.id].content) }}
					<button type="submit" class="btn btn-primary mt-3">Envoyer un message</button>
					{{ form_end(forms[userGroup.user.id]) }}
				</form>
			</div>
		</div>
	{% else %}
		<p>Vous n'avez pas encore de conversations.</p>
	{% endfor %}
</section>

 <script>
    document.addEventListener("DOMContentLoaded", function() {
        const toggleButtons = document.querySelectorAll('.toggle-conversation');
        
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = button.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                
                // Bascule de l'affichage de la discussion
                if (targetElement.style.display === "none" || targetElement.style.display === "") {
                    targetElement.style.display = "block";  // Affiche la discussion
                } else {
                    targetElement.style.display = "none";   // Masque la discussion
                }
            });
        });
    });
</script>

	
	{% endblock %}




