{% extends 'base.html.twig' %}

{% block title %}Mes Discussions{% endblock %}



{% block body %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/mess1.css') }}">
{% endblock %}
<div class="messages-page">

    <header class="messages-header">
        <h1>Mes Discussions</h1>
        <p>Retrouvez vos conversations et discutez en temps réel.</p>
    </header>

    <div class="messages-layout">

        <!-- LISTE CONVERSATIONS -->
        <aside class="card panel conversations-panel">
            <div class="panel-top">
                <h2 class="panel-title">Conversations</h2>
            </div>

            {% if conversations is empty %}
                <div class="empty">Aucune conversation.</div>
            {% else %}
                <div class="conversation-list">
                    {% for conversation in conversations %}
                        <div class="conversation-card">
                            <a href="{{ path('app_messages', { 'id': conversation.user.id }) }}" class="card-link">
                                <div class="conv-head">
                                    <img
                                        src="{{ asset(conversation.user.profile.avatar ? 'uploads/avatars/' ~ conversation.user.profile.avatar : 'uploads/avatars/default-avatar.png') }}"
                                        alt="Avatar"
                                        class="avatar"
                                    >
                                    <div class="conv-meta">
                                        <div class="pseudo">{{ conversation.user.pseudo }}</div>
                                        <div class="sub">Ouvrir la discussion</div>
                                    </div>
                                </div>
                            </a>

                            <div class="divider"></div>

                            <form action="{{ path('app_delete_conversation', { 'id': conversation.user.id }) }}"
                                  method="POST"
                                  onsubmit="return confirm('Voulez-vous vraiment supprimer cette conversation ?');">
                                <button type="submit" class="btn btn-danger btn-sm w-100">Supprimer</button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </aside>

        <!-- CONVERSATION -->
        <section class="card panel chat-panel">
            {% if receiver %}
                <div class="chat-header">
                    <div class="chat-title">
                        <h2>Conversation</h2>
                        <p>avec <strong>{{ receiver.pseudo }}</strong></p>
                    </div>
                </div>

                <div class="chat-box">
                    {% for message in messages %}
                        <div class="message {% if message.sender == app.user %}my-message{% else %}other-message{% endif %}">
                            <div class="message-meta">
                                <span class="who">
                                    {% if message.sender == app.user %}Moi{% else %}{{ receiver.pseudo }}{% endif %}
                                </span>
                            </div>

                            <div class="bubble">
                                {{ message.content }}
                            </div>

                            {% if message.isChatRequest and message.content == 'Demande de discussion en attente...' and message.receiver == app.user %}
                                <div class="request-actions">
                                    <form action="{{ path('app_message_response', { 'id': message.sender.id, 'status': 'accept' }) }}" method="POST">
                                        <button type="submit" class="btn btn-success btn-sm">Accepter</button>
                                    </form>
                                    <form action="{{ path('app_message_response', { 'id': message.sender.id, 'status': 'refuse' }) }}" method="POST">
                                        <button type="submit" class="btn btn-danger btn-sm">Refuser</button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="chat-footer">
                    {% if chatAccepted %}
                        <form action="{{ path('app_message_send', { 'id': receiver.id }) }}" method="POST" class="send-form">
                            <input type="text" name="content" class="form-control" placeholder="Écrire un message..." required>
                            <button type="submit" class="btn btn-primary">Envoyer</button>
                        </form>
                    {% else %}
                        <form action="{{ path('app_message_request', { 'id': receiver.id }) }}" method="POST">
                            <button type="submit" class="btn btn-warning w-100">Demander une discussion</button>
                        </form>
                    {% endif %}
                </div>
            {% else %}
                <div class="chat-empty">
                    <h2>Ouvrez une conversation</h2>
                    <p>Sélectionnez une personne afficher la discussion.</p>
                </div>
            {% endif %}
        </section>

    </div>
</div>
{% endblock %}
