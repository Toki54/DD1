{% extends 'base.html.twig' %}

{% block title %}Mes Discussions
{% endblock %}

{% block body %}
	{% block stylesheet %}
		<link rel="stylesheet" href="{{ asset('css/mess.css') }}">
	{% endblock %}

	<div class="container">
		<div
			class="row">
			<!-- Liste des Conversations -->
			<div class="col-md-4">
				<h3>Conversations</h3>
				{% if conversations is empty %}
					<p>Aucune conversation.</p>
				{% else %}
					<div class="conversation-list">
						{% for conversation in conversations %}
							<div class="conversation-card">
								<a href="{{ path('app_messages', { 'id': conversation.user.id }) }}" class="card-link">
									<div class="card-header">
										<img src="{{ asset(conversation.user.profile.avatar ? 'uploads/avatars/' ~ conversation.user.profile.avatar : 'uploads/avatars/default-avatar.png') }}" alt="Avatar" class="avatar">

										<strong class="pseudo">{{ conversation.user.pseudo }}</strong>
									</div>
								</a>
								<!-- Séparation entre avatar et contenu -->
								<hr class="divider">
								<form action="{{ path('app_delete_conversation', { 'id': conversation.user.id }) }}" method="POST" onsubmit="return confirm('Voulez-vous vraiment supprimer cette conversation ?');">
									<button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
								</form>

							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>

			<!-- Détails de la conversation -->
			<div class="col-md-8">
				{% if receiver %}
					<div class="conversation-detail-card">
						<div class="card-header">
							<h4>Conversation avec
								{{ receiver.pseudo }}</h4>
						</div>
						<div class="card-body chat-box">
							{% for message in messages %}
								<div class="message {% if message.sender == app.user %}my-message{% else %}other-message{% endif %}">
									<p>
										<strong>
											{% if message.sender == app.user %}Moi
											{% else %}
												{{ receiver.pseudo }}
											{% endif %}:
										</strong>
										{{ message.content }}
									</p>

									{% if message.isChatRequest and message.content == 'Demande de discussion en attente...' and message.receiver == app.user %}
										<form action="{{ path('app_message_response', { 'id': message.sender.id, 'status': 'accept' }) }}" method="POST">
											<button type="submit" class="btn btn-success">Accepter</button>
										</form>
										<form action="{{ path('app_message_response', { 'id': message.sender.id, 'status': 'refuse' }) }}" method="POST">
											<button type="submit" class="btn btn-danger">Refuser</button>
										</form>
									{% endif %}
								</div>
							{% endfor %}
						</div>

						<div class="card-footer">
							{% if chatAccepted %}
								<form action="{{ path('app_message_send', { 'id': receiver.id }) }}" method="POST">
									<input type="text" name="content" class="form-control" placeholder="Écrire un message..." required>
									<button type="submit" class="btn btn-primary">Envoyer</button>
								</form>
							{% else %}
								<form action="{{ path('app_message_request', { 'id': receiver.id }) }}" method="POST">
									<button type="submit" class="btn btn-warning">Demander une discussion</button>
								</form>
							{% endif %}
						</div>
					</div>
				{% endif %}

			</div>
		</div>
	</div>
{% endblock %}
