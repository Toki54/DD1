{% extends 'base.html.twig' %}

{% block title %}Mes Discussions
{% endblock %}

{% block body %}
	{% block stylesheet %}
		<link rel="stylesheet" href="{{ asset('css/mess.css') }}">
	{% endblock %}

	<div class="container my-5">
		<div
			class="row">
			<!-- Liste des Conversations -->
			<div class="col-md-4">
				<h3 class="mb-4">Conversations</h3>

				{% if conversations is empty %}
					<div class="alert alert-info">Aucune conversation.</div>
				{% else %}
					<div class="conversation-list">
						{% for conversation in conversations %}
							<div
								class="conversation-card mb-3 p-2 border rounded shadow-sm position-relative">
								<!-- Card cliquable vers la conversation -->
								<a href="{{ path('app_messages', { 'id': conversation.user.id }) }}" class="stretched-link"></a>

								<div class="d-flex align-items-center">
									<img src="{{ asset(conversation.user.profile.avatar ? 'uploads/avatars/' ~ conversation.user.profile.avatar : 'uploads/avatars/default-avatar.png') }}" alt="Avatar" class="avatar me-2 rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
									<div>
										<strong class="pseudo">
											<a href="{{ path('app_profile_view', { id: conversation.user.profile.id }) }}" onclick="event.stopPropagation(); event.preventDefault(); window.location.href=this.href;">{{ conversation.user.pseudo }}</a>
										</strong><br>
										<small>
											{{ conversation.user.profile.sex|default('Sexe inc.') }}
											-
											{% if conversation.user.profile.birthdate %}
												{% set now = "now"|date("Y") %}
												{% set birthYear = conversation.user.profile.birthdate|date("Y") %}
												{{ now - birthYear }}
												ans
											{% else %}
												Ã‚ge inc.
											{% endif %}
										</small>
									</div>
								</div>

								<hr class="my-2">

								<form action="{{ path('app_delete_conversation', { 'id': conversation.user.id }) }}" method="POST" onsubmit="return confirm('Voulez-vous vraiment supprimer cette conversation ?');">
									<button type="submit" class="btn btn-danger btn-sm w-100">Supprimer</button>
								</form>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>

			<!-- DÃ©tails de la conversation -->
			<div class="col-md-8">
				{% if receiver %}
					<div class="conversation-detail-card border rounded shadow p-3">
						<div class="card-header mb-3">
							<h4>Conversation avec
								<a href="{{ path('app_profile_view', { id: receiver.profile.id }) }}">{{ receiver.pseudo }}</a>
							</h4>
						</div>

						<div class="card-body chat-box mb-3" style="max-height: 500px; overflow-y: auto;">
							{% for message in messages %}
								<div class="message mb-2 {% if message.sender == app.user %}text-end{% else %}text-start{% endif %}">
									<p class="mb-1">
										<strong>
											{% if message.sender == app.user %}Moi
											{% else %}
												{{ receiver.pseudo }}
											{% endif %}
											:
										</strong>
										{{ message.content }}
									</p>

									{% if message.isChatRequest and message.content == 'Demande de discussion en attente...' and message.receiver == app.user %}
										<div class="d-flex gap-2">
											<form action="{{ path('app_message_response', { 'id': message.sender.id, 'status': 'accept' }) }}" method="POST">
												<button type="submit" class="btn btn-success btn-sm">Accepter</button>
											</form>
											<form action="{{ path('app_message_response', { 'id': message.sender.id, 'status': 'refuse' }) }}" method="POST">
												<button type="submit" class="btn btn-danger btn-sm">Refuser</button>
											</form>
										</div>
									{% endif %}
								</div>
							{% endfor %}
						</div>

						<div class="card-footer">
							{% if chatAccepted %}
								<form action="{{ path('app_message_send', { 'id': receiver.id }) }}" method="POST" class="d-flex gap-2">
									<input type="text" name="content" class="form-control" placeholder="Ã‰crire un message..." required>
									<button type="submit" class="btn btn-primary">Envoyer</button>
								</form>
							{% else %}
								<form action="{{ path('app_message_request', { 'id': receiver.id }) }}" method="POST">
									<button type="submit" class="btn btn-warning">Demander une discussion</button>
								</form>
							{% endif %}
						</div>
					</div>
				{% else %}
					<!-- Aucun utilisateur sÃ©lectionnÃ© -->
					<div class="text-center p-5 rounded shadow">
						<img src="{{ asset('images/messagerie.png') }}" alt="Messagerie" class="mb-4" style="max-width: 180px;">
						<h2 class="mb-3 text-gold">Bienvenue dans votre messagerie ðŸ’¬</h2>
						<p class="mb-4">Vous n'avez pas encore de discussion active.<br>Visitez les profils pour dÃ©marrer une conversation.</p>
						<a href="{{ path('app_profiles_list') }}" class="btn-prof" >Explorer les profils</a>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
{% endblock %}

