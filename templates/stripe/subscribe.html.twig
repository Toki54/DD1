{% extends 'base.html.twig' %}

{% block title %}Souscription
{% endblock %}



{% block body %}
{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('css/abo.css') }}">
{% endblock %}

	<h1>Souscrire à un abonnement</h1>

	<div class="subscription-cards">
		<div class="subscription-card" data-plan="1 semaine - 5 €" data-amount="5">
			<h3>1 Semaine</h3>
			<p>5 €</p>
			<p>Accès complet pendant 7 jours</p>
			<button class="btn btn-primary" onclick="selectPlan(this)">Choisir</button>
		</div>

		<div class="subscription-card" data-plan="1 mois - 15 €" data-amount="15">
			<h3>1 Mois</h3>
			<p>15 €</p>
			<p>Accès complet pendant 1 mois</p>
			<button class="btn btn-primary" onclick="selectPlan(this)">Choisir</button>
		</div>

		<div class="subscription-card" data-plan="3 mois - 30 €" data-amount="30">
			<h3>3 Mois</h3>
			<p>30 €</p>
			<p>Accès complet pendant 3 mois</p>
			<button class="btn btn-primary" onclick="selectPlan(this)">Choisir</button>
		</div>

		<div class="subscription-card" data-plan="6 mois - 50 €" data-amount="50">
			<h3>6 Mois</h3>
			<p>50 €</p>
			<p>Accès complet pendant 6 mois</p>
			<button class="btn btn-primary" onclick="selectPlan(this)">Choisir</button>
		</div>

		<div class="subscription-card" data-plan="1 an - 80 €" data-amount="80">
			<h3>1 An</h3>
			<p>80 €</p>
			<p>Accès complet pendant 1 an</p>
			<button class="btn btn-primary" onclick="selectPlan(this)">Choisir</button>
		</div>
	</div>

	<div id="subscription-summary" style="display:none;">
		<h3>Résumé de l'abonnement</h3>
		<p>
			<strong>Abonnement sélectionné :</strong>
			<span id="plan-name"></span>
		</p>
		<p>
			<strong>Prix :</strong>
			<span id="plan-price"></span>
		</p>
		<button id="checkout-button" disabled>Payer avec Stripe</button>
	</div>

	 <script src="https://js.stripe.com/v3/"></script>
	 <script>
	        let selectedPlan = '';
	        let selectedAmount = 0;
	
	        function selectPlan(button) {
	            const card = button.closest('.subscription-card');
	            selectedPlan = card.getAttribute('data-plan');
	            selectedAmount = parseFloat(card.getAttribute('data-amount'));
	
	            document.getElementById('plan-name').textContent = selectedPlan;
	            document.getElementById('plan-price').textContent = selectedAmount + ' €';
	            document.getElementById('subscription-summary').style.display = 'block';
	
	            const checkoutBtn = document.getElementById('checkout-button');
	            checkoutBtn.disabled = false;
	            checkoutBtn.classList.add('enabled');
	        }
	
	        document.addEventListener('DOMContentLoaded', function () {
	            const checkoutButton = document.getElementById('checkout-button');
	
	            checkoutButton.addEventListener('click', function () {
	                if (checkoutButton.disabled) return;
	
	                fetch('{{ path('app_stripe_checkout') }}', {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                    },
	                    body: JSON.stringify({
	                        plan: selectedPlan,
	                        amount: selectedAmount
	                    })
	                })
	                .then(response => response.json())
	                .then(data => {
	                    if (data.id) {
	                        const stripe = Stripe('{{ stripe_public_key }}');
	                        stripe.redirectToCheckout({ sessionId: data.id });
	                    } else {
	                        alert('Erreur lors de la création de la session Stripe.');
	                    }
	                })
	                .catch(() => {
	                    alert('Erreur réseau ou serveur.');
	                });
	            });
	        });
	    </script>
{% endblock %}

